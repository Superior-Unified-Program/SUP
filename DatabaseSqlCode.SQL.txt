USE [master]
GO

/*Create database*/
IF NOT EXISTS (SELECT * FROM master.dbo.sysdatabases WHERE '[' + name + ']' = 'SUPdb' OR name = 'SUPdb')
   exec('CREATE DATABASE [SUPdb] CONTAINMENT = NONE')
GO

/* create User If possible */
--CREATE LOGIN teamRADGSHAUser
USE [master]
IF NOT EXISTS (SELECT name FROM master.sys.server_principals WHERE name = 'SUPuser')
   exec('CREATE LOGIN SUPuser WITH PASSWORD = ''abc123''')
GO

--create user
USE [SUPdb]
IF USER_ID('SUPuser') IS NULL exec('CREATE USER [SUPuser] FOR LOGIN [SUPuser]')
GO

--update roles
GRANT EXECUTE TO SUPuser
GO

--create tables
IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'Account')
CREATE TABLE Account (
  User_Name varchar(25),
  Salt CHAR(25),
  Password binary(64),
  User_Type char(1),
  Failed_Login int,
  Office varchar(50)
  CONSTRAINT PK_SecurityAccounts PRIMARY KEY (User_Name)
)

IF NOT EXISTS (SELECT *  FROM sys.indexes  WHERE name='Index_SecurityAccounts' 
    AND object_id = OBJECT_ID('Account'))
CREATE UNIQUE INDEX Index_SecurityAccounts
    ON dbo.Account (User_Name) INCLUDE (Salt, Password)
GO

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'AccountAudits')
CREATE TABLE AccountAudits(
    ChangeID INT IDENTITY PRIMARY KEY,
    User_Name varchar(25) NOT NULL,
	User_Type CHAR(1) NOT NULL,
    Failed_Login INT NULL,
    office varchar(50) NULL,
    updated_at DATETIME NOT NULL,
    operation varchar(20) NOT NULL
)
GO

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'Client')
CREATE TABLE Client ( ID int not null IDENTITY(1,1) PRIMARY KEY, Prefix varchar(10), Last_Name varchar(50), First_Name varchar(50), Middle_initial char, Permit_Num varchar(10), Active bit, Notes varchar(30))

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'Address')
CREATE TABLE Address ( Client_ID int, Line1 varchar(35), Line2 varchar(35), City varchar(25), State char(2), Zip char(5), 
CONSTRAINT PK_Address PRIMARY KEY ( Client_ID ), 
CONSTRAINT FK_Address_Client FOREIGN KEY (Client_ID) REFERENCES Client (ID) )

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'Phone')
CREATE TABLE Phone ( Client_ID int, Type varchar(10), [Number] varchar(11), CONSTRAINT PK_Phone_TEST PRIMARY KEY ( Client_ID, [Type]),
CONSTRAINT FK_Phone_Client_TEST FOREIGN KEY (Client_ID) REFERENCES Client (ID)  )

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'Email')
CREATE TABLE Email ( Client_ID int, Type varchar(10), [Email] varchar(30), CONSTRAINT PK_Email_TEST PRIMARY KEY ( Client_ID, [Type]), 
CONSTRAINT FK_Email_Client_TEST FOREIGN KEY (Client_ID) REFERENCES Client (ID)  )

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'Organization')
CREATE TABLE Organization ( [Name] varchar(30), [Type] varchar(20), 
CONSTRAINT PK_Organization PRIMARY KEY ( [Name], [Type] ) )

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'Works_For')
CREATE TABLE Works_For ( Client_ID int, Org_Name varchar(30), Org_Type varchar(20), Title varchar(20), 
CONSTRAINT PK_Works_For PRIMARY KEY ( Client_ID, Org_Name, Org_Type ), 
CONSTRAINT FK_Works_For_Client FOREIGN KEY (Client_ID) REFERENCES Client (ID), 
CONSTRAINT FK_Works_For_Organization FOREIGN KEY (Org_Name, Org_type) REFERENCES Organization ( [Name], [Type] ) )

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'Assistant')
CREATE TABLE Assistant ( Boss_ID int, First_Name varchar(50), Last_Name varchar(50), 
CONSTRAINT PK_Assists PRIMARY KEY ( Boss_ID ), 
CONSTRAINT FK_Assists_Boss_Client FOREIGN KEY (Boss_ID) REFERENCES Client (ID) )

GO

---creation of any triggers
-----------------------------------------------------------------------------------------------------------------------------
IF NOT EXISTS (SELECT * FROM sys.objects WHERE [name] = 'trgAccountAuditInsDel')
EXEC('CREATE TRIGGER trgAccountAuditInsDel
ON Account
AFTER INSERT, DELETE
AS
BEGIN
SET NOCOUNT ON;
INSERT INTO AccountAudits(
        User_Name, 
        User_Type,
        Failed_Login,
        office,
        updated_at, 
        operation
    )
    SELECT
        d.User_Name,
        User_Type,
        Failed_Login,
        office,
        GETDATE(),
        ''delete''
    FROM
        deleted d
    UNION ALL
	SELECT
        i.User_Name,
        User_Type,
        Failed_Login,
        office,
        GETDATE(),
        ''insert''
    FROM
        inserted i
END
GO')

IF NOT EXISTS (SELECT * FROM sys.objects WHERE [name] = 'trgAccountAuditUpdate')
EXEC('CREATE TRIGGER trgAccountAuditUpdate
ON Account
AFTER UPDATE
AS
BEGIN
SET NOCOUNT ON;
INSERT INTO AccountAudits(
        User_Name, 
        User_Type,
        Failed_Login,
        office,
        updated_at, 
        operation
    )
    SELECT
        d.User_Name,
        User_Type,
        Failed_Login,
        office,
        GETDATE(),
        ''update-old''
    FROM
        deleted d
    UNION ALL
	SELECT
        i.User_Name,
        User_Type,
        Failed_Login,
        office,
        GETDATE(),
        ''update-new''
    FROM
        inserted i
END
GO')

--creation of any views
-----------------------------------------------------------------------------------------------------------------------------
--creates a view that is used in the queryClientFull SP
USE [SUPdb]
IF OBJECT_ID('viewall', 'V') IS NOT NULL
DROP VIEW viewAll
GO

CREATE VIEW viewAll
AS
	SELECT ID, Prefix, Client.Last_Name, Client.First_Name, Middle_initial, Assistant.First_Name AS 'Assistant_First_Name', Assistant.Last_Name AS 'Assistant_Last_Name', Permit_Num, Active, Notes, Line1, Line2, City, State, Zip, Org_Name, Org_Type, Title FROM Client 
		FULL JOIN [Address] ON ID = Address.Client_ID
		FULL JOIN Works_For ON ID = Works_For.Client_ID
		FULL JOIN Assistant ON ID = Assistant.Boss_ID
GO

--creation of any stored Procedures
-------------------------------------------------------------------------------------------------------------------------------


-- =============================================
-- Create date: 10/24/2019
-- Description:	validates log in information with hash and salt
-- =============================================
IF NOT EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND OBJECT_ID = OBJECT_ID('validateLogin'))
   exec('CREATE PROCEDURE validateLogin AS BEGIN SET NOCOUNT ON END')
GO
ALTER PROCEDURE validateLogin

	-- Add the parameters for the stored procedure here
	@userName nvarchar(50), @givenPW varchar(100)
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here

	DECLARE @dateTimeNow DATETIME
	DECLARE @dateTimeFailed DATETIME
	DECLARE @isLocked BIT = 0
	DECLARE @isValid BIT
	DECLARE @Salt VARCHAR(25)
	DECLARE @PwdWithSalt VARCHAR(125)
	DECLARE @PwdHash binary(64)
	DECLARE @hashPass binary(64)
	DECLARE @cnt INT = 0

	-- reset failed login if time since last attempt is >= 15 minutes 
	SET @dateTimeNow = GETDATE()
	SET @dateTimeFailed = (SELECT updated_at FROM AccountAudits WHERE User_Name = @userName AND ChangeID = (SELECT MAX(ChangeID) FROM AccountAudits WHERE User_Name = @userName) )
	IF (DATEDIFF(minute, @dateTimeFailed, @dateTimeNow) > 15) UPDATE Account SET Failed_login = 0 WHERE User_Name = @userName


	-- get salt and hashed password
	SELECT @Salt = Salt, @PwdHash = [Password] FROM Account WHERE User_Name = @userName

	-- apply salt to password parameter
	SET @PwdWithSalt = @Salt + @givenPW

	-- hash once
	SET @hashPass = HASHBYTES('SHA2_512', @PwdWithSalt)

	-- hash 500101 more times
	WHILE @cnt < '500101'
	BEGIN
		SET @hashPass = HASHBYTES('SHA2_512', @hashPass) 
		SET @cnt = @cnt + 1;
	END

	-- check for validity of password
	IF (@hashPass = @PwdHash) SET @isValid = 1
	ELSE SET @isValid = 0

	-- check for lockout and revoke validity if too many failed logins
	IF ((SELECT Failed_login FROM Account WHERE User_Name = @userName) > 5)
	BEGIN
		SET @isValid = 0
		SET @isLocked = 1
	END

	-- update failed logins
	IF @isValid = 0
	BEGIN
		IF ((SELECT Failed_login FROM Account WHERE User_Name = @userName) IS NOT NULL OR (SELECT Failed_login FROM Account WHERE User_Name = @userName) = 0) UPDATE Account SET Failed_Login = Failed_Login + 1 WHERE User_Name = @userName
		ELSE UPDATE Account SET Failed_Login = 1
	END
	ELSE UPDATE ACCOUNT SET Failed_Login = 0 WHERE User_Name = @userName

	-- create temp table to return to middleware
	CREATE TABLE #results (Valid_Login bit, Account_Locked bit, Failed_Attempts int)
	INSERT INTO #results (Valid_Login, Account_Locked, Failed_Attempts) VALUES(@isValid, @isLocked, (SELECT Failed_login FROM Account WHERE User_Name = @userName))
	SELECT * FROM #results

	-- drop temp table
	DROP TABLE #results

END
GO

-- =============================================
-- Create date: 10/7/2019
-- Description:	Takes 3 variables and returns clients that begin with the given variables. Input variables are allowed to be nulled.
-- =============================================
IF NOT EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND OBJECT_ID = OBJECT_ID('queryClientFull'))
   exec('CREATE PROCEDURE queryClientFull AS BEGIN SET NOCOUNT ON END')
GO
ALTER PROCEDURE queryClientFull
	-- Add the parameters for the stored procedure here
	@lastName varchar(50) = '', @firstName nvarchar(30) = '',
	@orgType varchar(30) = '', @title varchar(20) = ''

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	IF @orgType IS NULL SET @orgType = ''
	IF @lastName IS NULL SET @lastName = ''
	IF @firstName IS NULL SET @firstName = ''
	IF @title IS NULL SET @title = ''


	CREATE TABLE #searchResults (ID int, Prefix varchar(10), Last_Name varchar(50), First_Name varchar(50), Middle_initial varchar(1), Assistant_First_Name varchar(50), Assisntant_Last_Name varchar(50), Permit_Num varchar(10), Active bit, Notes varchar(30),
		Line1 varchar(35), Line2 varchar(35), City varchar(25), State varchar(2), Zip varChar(5), Org_Name varchar(30), Org_Type varchar(20), Title varchar(20))

	INSERT INTO #searchResults SELECT * FROM [viewAll]

	ALTER TABLE #searchResults ADD Personal_Email varchar(30), Business_Email varchar(30), Assistant_Email varchar(30), Personal_Phone varchar(11), Business_Phone varchar(11), Assistant_Phone varchar(30)

	UPDATE #searchResults SET Personal_Email = (SELECT Email FROM Email WHERE Client_ID = ID AND Type = 'personal')
	UPDATE #searchResults SET Business_Email = (SELECT Email FROM Email WHERE Client_ID = ID AND Type = 'business')
	UPDATE #searchResults SET Assistant_Email = (SELECT Email FROM Email WHERE Client_ID = ID AND Type = 'assistant')
	UPDATE #searchResults SET Personal_Phone = (SELECT Number FROM Phone WHERE Client_ID = ID AND Type = 'personal')
	UPDATE #searchResults SET Business_Phone = (SELECT Number FROM Phone WHERE Client_ID = ID AND Type = 'business')
	UPDATE #searchResults SET Assistant_Phone = (SELECT Number FROM Phone WHERE Client_ID = ID AND Type = 'assistant')

	SELECT ID, Prefix, Last_Name, First_Name, Middle_initial, Permit_Num, Assistant_First_Name, Assisntant_Last_Name, Active, Notes, ID AS 'Client_ID', Line1, Line2, City, State, Zip, ID AS 'Client_ID', Org_Name, Org_Type, Title, 
		ID AS 'Client_ID', Personal_Email, Business_Email, Assistant_Email, ID AS 'Client_ID', Personal_Phone, Business_Phone, Assistant_Phone FROM #searchResults
	WHERE First_Name LIKE (@firstName + '%') 
		AND Last_Name LIKE (@lastName + '%') 
		AND Org_type LIKE (@orgType + '%')
		AND Title LIKE (@title + '%') OR Title IS NULL
	ORDER BY Last_Name, First_Name, Middle_initial, Org_Type

	DROP TABLE #searchResults

END
GO

-- =============================================
-- Create date: 10/7/2019
-- Description:	adds a client into the client table
-- =============================================
IF NOT EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND OBJECT_ID = OBJECT_ID('addClient'))
   exec('CREATE PROCEDURE addClient AS BEGIN SET NOCOUNT ON END')
GO
ALTER PROCEDURE addClient

	-- Add the parameters for the stored procedure here
	@prefix varchar(10) = null, @firstName varchar(50),
	@lastName varchar(50), @middleInitial varchar(1) = null,
	@permitNum varchar(50) = null,
	@active bit = 1, @notes varchar(30) = '',
	@orgName varchar(30), @orgType varchar(20),
	@title varchar(20) = null, @Personal_phoneNumber varchar(11) = null,
	@Business_phoneNumber varchar(11) = null, @Personal_Email varchar(30) = null,
	@Business_Email varchar(30) = null, @Assistant_Email varchar(30) = null,
	@Assistant_phoneNumber varchar(11) = null, @line1 varchar(35) = null,
	@line2 varchar(35) = null, @city varchar(25) = null,
	@state varchar(2) = null, @zipCode varchar(5) = null,
	@assistantFirstName varchar(50) = null, @assistantLastName varchar(50) = null
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	INSERT INTO Client (First_Name, Last_Name, Middle_initial, Permit_Num, Client.Active, Notes) VALUES (@firstName, @lastName, @middleInitial, @permitNum, @active, @notes)
	
	-- declare an int and set its value based on the auto generated ID from inserting into the client table in the previous line
	DECLARE @ID int
	SET @ID = SCOPE_IDENTITY()

	-- set values into the tables. dont repeat adding to organization table in the case that the organization and type already exist in the database
	IF (SELECT COUNT(*) FROM Organization WHERE Name = @orgName AND Type = @orgType) = 0 INSERT INTO Organization(Name, Type) VALUES(@orgName, @orgType)
	INSERT INTO Works_For(Client_ID, Org_Name, Org_Type, Title) VALUES (@ID, @orgName, @orgType, @title)
	INSERT INTO Address(Client_ID, Line1, Line2, City, State, Zip) VALUES(@ID, @line1, @line2, @city, @state, @zipCode)

	INSERT INTO Phone(Client_ID, Type, Number) VALUES (@ID, 'business', @Business_phoneNumber)
	INSERT INTO Phone(Client_ID, Type, Number) VALUES (@ID, 'personal', @Personal_phoneNumber)
	INSERT INTO Phone(Client_ID, Type, Number) VALUES (@ID, 'assistant', @Assistant_phoneNumber)

	INSERT INTO Email(Client_ID, Type, Email) VALUES (@ID, 'business', @Business_Email)
	INSERT INTO Email(Client_ID, Type, Email) VALUES (@ID, 'personal', @Personal_Email)
	INSERT INTO Email(Client_ID, Type, Email) VALUES (@ID, 'assistant', @Assistant_Email)

	INSERT INTO Assistant(Boss_ID, First_Name, Last_Name) VALUES (@ID, @assistantFirstName, @assistantLastName)
	
	RETURN @ID

END
GO

-- =============================================
-- Create date: 10/7/2019
-- Description:	checks for a near match and sends the match if difference is >=3. Also reports the client where the difference function is >=3
-- =============================================
IF NOT EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND OBJECT_ID = OBJECT_ID('checkForNearMatch'))
   exec('CREATE PROCEDURE checkForNearMatch AS BEGIN SET NOCOUNT ON END')
GO
ALTER PROCEDURE checkForNearMatch

	-- Add the parameters for the stored procedure here
	@firstName varchar(50) = null, @lastName varchar(50) = null
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here

	SELECT ID, First_Name, Last_Name FROM Client WHERE DIFFERENCE(@firstName, First_Name) > 2 AND DIFFERENCE(@lastName, Last_Name) > 2

END
GO

-- =============================================
-- Create date: 10/10/2019
-- Description:	Adds a user to the Account table
-- =============================================
IF NOT EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND OBJECT_ID = OBJECT_ID('addAccount'))
   exec('CREATE PROCEDURE addAccount AS BEGIN SET NOCOUNT ON END')
GO
ALTER PROCEDURE addAccount
	-- Add the parameters for the stored procedure here
	@userName varchar(25), @password varchar(64),
	@userType char(1) = null, @office varchar(50) = null
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    	-- Insert statements for procedure here
	DECLARE @Salt VARCHAR(25)
	DECLARE @cnt INT = 0
	DECLARE @PwdWithSalt VARCHAR(125)
	DECLARE @seed int
	DECLARE @count tinyint
	DECLARE @currentTime DATETIME
	DECLARE @hashedPass binary(64)

	-- build salt w/ seed
	SET @currentTime = GETDATE()
	SET @seed = (DATEPART(hh, @currentTime) * 10000000) + (DATEPART(n, @currentTime) * 100000) + (DATEPART(s, @currentTime) * 1000) + DATEPART(ms, @currentTime)
	SET @count = 1
	SET @salt = CHAR(ROUND((RAND(@seed) * 90) + 12, 3))

	-- build salt to 25 random characters
	WHILE (@count < 25)
	BEGIN
		SET @Salt = @Salt + CHAR(ROUND((RAND() * 90) + 12, 3))
		SET @count = @count + 1
	END

	-- combine salt with password
	SET @PwdWithSalt = @Salt + @password

	-- initial hash
	SET @hashedPass = HASHBYTES('SHA2_512', @PwdWithSalt)

	-- hash 500101 more times
	WHILE @cnt < '500101'
	BEGIN
		SET @hashedPass = HASHBYTES('SHA2_512', @hashedPass) 
		SET @cnt = @cnt + 1;
	END
	
	--insert values in Account table
	INSERT INTO Account (User_Name, Salt, Password, User_Type, Office) VALUES (@userName, @Salt, @hashedPass, @userType, @office)

END
GO

-- =============================================
-- Create date: 10/25/2019
-- Description:	updates tables based on parameters given
-- =============================================
IF NOT EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND OBJECT_ID = OBJECT_ID('updateClient'))
   exec('CREATE PROCEDURE updateClient AS BEGIN SET NOCOUNT ON END')
GO
ALTER PROCEDURE updateClient
	-- Add the parameters for the stored procedure here
	@ID int, @prefix varchar(10) = null, @firstName varchar(50),
	@lastName varchar(50), @middleInitial varchar(1) = null,
	@permitNum varchar(50) = null,
	@active bit = 1, @notes varchar(30) = '',
	@orgName varchar(30), @orgType varchar(20),
	@title varchar(20) = null, @Personal_phoneNumber varchar(11) = null,
	@Business_phoneNumber varchar(11) = null, @Personal_Email varchar(30) = null,
	@Business_Email varchar(30) = null, @Assistant_Email varchar(30) = null,
	@Assistant_phoneNumber varchar(11) = null, @line1 varchar(35) = null,
	@line2 varchar(35) = null, @city varchar(25) = null,
	@state varchar(2) = null, @zipCode varchar(5) = null,
	@assistantFirstName varchar(50) = null, @assistantLastName varchar(50) = null

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- update values in the tables.
	IF @prefix IS NOT NULL
		UPDATE Client SET Prefix = @prefix WHERE ID = @ID
	IF @firstName IS NOT NULL 
		UPDATE Client SET First_Name = @firstName WHERE ID = @ID
	IF @lastName IS NOT NULL 
		UPDATE Client SET Last_Name = @lastName WHERE ID = @ID
	IF @middleInitial IS NOT NULL 
		UPDATE Client SET Middle_initial = @middleInitial WHERE ID = @ID
	IF @permitNum IS NOT NULL 
		UPDATE Client SET Permit_Num = @permitNum WHERE ID = @ID
	IF @active IS NOT NULL 
		UPDATE Client SET Active = @active WHERE ID = @ID
	IF @notes IS NOT NULL 
		UPDATE Client SET Notes = @notes WHERE ID = @ID
	-- 
	IF (SELECT COUNT(*) FROM Organization WHERE [Name] = @orgName AND [Type] = @orgType) = 0 AND (@orgName IS NOT NULL OR @orgType IS NOT NULL )
		INSERT INTO Organization([Name], [Type]) VALUES(@orgName, @orgType)
	IF @orgName IS NOT NULL OR @orgType IS NOT NULL 
		UPDATE Organization SET [Name] = @orgName, [Type] = @orgType 
			WHERE [Name] = @orgName AND [Type] = @orgType
	IF @title IS NOT NULL 
		UPDATE Works_For SET Title = @title 
			WHERE Client_ID = @ID AND Org_Name = @orgName AND Org_Type = @orgType


	--------------------------------------------------------------------------------------------
	IF (SELECT COUNT(*) FROM Phone WHERE Client_ID = @ID AND [Type] = 'business') = 0 AND @Business_phoneNumber IS NOT NULL 
		INSERT INTO Phone(Client_ID, [Type], Number) VALUES(@ID, 'business', @Business_phoneNumber)
	IF @Business_phoneNumber IS NOT NULL 
		UPDATE Phone SET Number = @Business_phoneNumber 
			WHERE Client_ID = @ID AND [Type] = 'business'

	IF (SELECT COUNT(*) FROM Phone WHERE Client_ID = @ID AND [Type] = 'personal') = 0 AND @Personal_phoneNumber IS NOT NULL 
		INSERT INTO Phone(Client_ID, [Type], Number) VALUES(@ID, 'personal', @Personal_phoneNumber)
	IF @Personal_phoneNumber IS NOT NULL 
		UPDATE Phone SET Number = @Personal_phoneNumber 
			WHERE Client_ID = @ID AND [Type] = 'personal'
	--
	IF (SELECT COUNT(*) FROM Email WHERE Client_ID = @ID AND [Type] = 'business') = 0 AND @Business_email IS NOT NULL 
		INSERT INTO Email(Client_ID, [Type], Email) VALUES(@ID, 'business', @Business_email)
	IF @Business_email IS NOT NULL 
		UPDATE Email SET Email = @Business_email 
			WHERE Client_ID = @ID AND [Type] = 'business'

	IF (SELECT COUNT(*) FROM Email WHERE Client_ID = @ID AND [Type] = 'personal') = 0 AND @Personal_email IS NOT NULL 
		INSERT INTO Email(Client_ID, [Type], Email) VALUES(@ID, 'personal', @Personal_email)
	IF @Personal_email IS NOT NULL 
		UPDATE Email SET Email = @Personal_email 
			WHERE Client_ID = @ID AND [Type] = 'personal'
	
	---------------------------------------------------------------------------------------------
	--
	IF (SELECT COUNT(*) FROM [Address] WHERE Client_ID = @ID) = 0 AND (@line1 IS NOT NULL OR @line2 IS NOT NULL OR @city IS NOT NULL OR @state IS NOT NULL OR @zipCode IS NOT NULL )
		INSERT INTO Address(Client_ID, Line1, Line2, City, [State], Zip) VALUES(@ID, @line1, @line2, @city, @state, @zipCode)
	IF @line1 IS NOT NULL OR @line2 IS NOT NULL OR @city IS NOT NULL OR @state IS NOT NULL OR @zipCode IS NOT NULL 
		UPDATE [Address] SET Line1 = @line1, Line2 = @line2, City = @city, [State] = @state, Zip = @zipCode
			WHERE Client_ID = @ID 
	
	---------------------------------------------------------------------------------------------

	IF ((SELECT COUNT(*) FROM Assistant WHERE Boss_ID = @ID) = 0) AND (@assistantFirstName IS NOT NULL OR @assistantLastName IS NOT NULL OR @Assistant_Email IS NOT NULL OR @Assistant_phoneNumber IS NOT NULL)
		Begin	INSERT INTO Assistant(Boss_ID, First_Name, Last_Name) VALUES(@ID, @assistantFirstName, @assistantLastName) 
				INSERT INTO Phone(Client_ID, [Type], Number) VALUES(@ID, 'assistant', @Assistant_phoneNumber)
				INSERT INTO Email(Client_ID, [Type], Email) VALUES(@ID, 'assistant', @Assistant_Email)
		END
	IF (@assistantFirstName IS NOT NULL OR @assistantLastName IS NOT NULL OR @Assistant_Email IS NOT NULL OR @Assistant_phoneNumber IS NOT NULL)
		Begin	UPDATE Assistant SET First_Name = @assistantFirstName, Last_Name = @assistantLastName 
					WHERE Boss_ID = @ID
				UPDATE Phone SET Number = @Assistant_phoneNumber 
					WHERE Client_ID = @ID AND [Type] = 'assistant'
				UPDATE Email SET Email = @Assistant_Email 
					WHERE Client_ID = @ID AND [Type] = 'assistant'
		END

	return @ID

END
GO

-- =============================================
-- Create date: 10/12/2019
-- Description:	Returns all data for a single client by searching for the ID
-- =============================================
IF NOT EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND OBJECT_ID = OBJECT_ID('getClientByIdFull'))
   exec('CREATE PROCEDURE getClientByIdFull AS BEGIN SET NOCOUNT ON END')
GO
ALTER PROCEDURE getClientByIdFull
	-- Add the parameters for the stored procedure here
    @Client_Id int

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

	-- Insert statements for procedure here

	
	CREATE TABLE #searchResults (ID int, Prefix varchar(10), Last_Name varchar(50), First_Name varchar(50), Middle_initial varchar(1), Assistant_First_Name varchar(50), Assisntant_Last_Name varchar(50), Permit_Num varchar(10), Active bit, Notes varchar(30),
		Line1 varchar(35), Line2 varchar(35), City varchar(25), State varchar(2), Zip varChar(5), Org_Name varchar(30), Org_Type varchar(20), Title varchar(20))

	INSERT INTO #searchResults SELECT * FROM [viewAll]

	ALTER TABLE #searchResults ADD Personal_Email varchar(30), Business_Email varchar(30), Assistant_Email varchar(30), Personal_Phone varchar(11), Business_Phone varchar(11), Assistant_Phone varchar(30)

	UPDATE #searchResults SET Personal_Email = (SELECT Email FROM Email WHERE Client_ID = ID AND Type = 'personal')
	UPDATE #searchResults SET Business_Email = (SELECT Email FROM Email WHERE Client_ID = ID AND Type = 'business')
	UPDATE #searchResults SET Assistant_Email = (SELECT Email FROM Email WHERE Client_ID = ID AND Type = 'assistant')
	UPDATE #searchResults SET Personal_Phone = (SELECT Number FROM Phone WHERE Client_ID = ID AND Type = 'personal')
	UPDATE #searchResults SET Business_Phone = (SELECT Number FROM Phone WHERE Client_ID = ID AND Type = 'business')
	UPDATE #searchResults SET Assistant_Phone = (SELECT Number FROM Phone WHERE Client_ID = ID AND Type = 'assistant')

	SELECT ID, Prefix, Last_Name, First_Name, Middle_initial, Permit_Num, Assistant_First_Name, Assisntant_Last_Name, Active, Notes, ID AS 'Client_ID', Line1, Line2, City, State, Zip, ID AS 'Client_ID', Org_Name, Org_Type, Title, 
		ID AS 'Client_ID', Personal_Email, Business_Email, Assistant_Email, ID AS 'Client_ID', Personal_Phone, Business_Phone, Assistant_Phone FROM #searchResults
	WHERE ID = @Client_Id

	DROP TABLE #searchResults

END
GO

-- =============================================
-- Create date: 11/1/2019
-- Description: adds dummy
-- =============================================
IF NOT EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND OBJECT_ID = OBJECT_ID('addDummyData'))
   exec('CREATE PROCEDURE addDummyData AS BEGIN SET NOCOUNT ON END')
GO
ALTER PROCEDURE addDummyData
	-- Add the parameters for the stored procedure here

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
EXEC	addCLient
		@Prefix = 'Mr.',
		@firstName = N'Matt',
		@lastName = N'Holcomb',
		@middleInitial = N'J',
		@permitNum = NULL,
		@notes = N'VIP',
		@orgName = N'Foresty Dept',
		@orgType = N'County',
		@title = N'park worker',
		@Personal_phoneNumber = N'1234564132',
		@Business_phoneNumber = N'2132165466',
		@Personal_Email = N'email@server.com',
		@Business_Email = 'businessEmail@server.com',
		@line1 = N'123 ThatStreet',
		@line2 = N'apt 102',
		@city = N'superior',
		@state = N'WI',
		@zipCode = N'54880',
		@Assistant_phoneNumber = '123456779',
		@Assistant_Email = 'assistantEmail@server.com',
		@assistantFirstName = 'Billy',
		@assistantLastName = 'Joe'

EXEC	addCLient
		@firstName = N'Jim',
		@lastName = N'Holcomb',
		@permitNum = NULL,
		@notes = N'notes and such',
		@orgName = N'FBI',
		@orgType = N'Government',
		@title = N'lead banker',
		@Business_phoneNumber = N'1231475646',
		@Personal_Email = N'thatOneGuy@server.com',
		@line1 = N'149 Cranberry Lane',
		@line2 = N'apt 508',
		@city = N'superior',
		@state = N'WI',
		@zipCode = N'54880'

EXEC	addCLient
		@firstName = N'Alen',
		@lastName = N'Johnson',
		@middleInitial = N'Z',
		@permitNum = N'Z699',
		@notes = N'notes and other stuff',
		@orgName = N'UW-super',
		@orgType = N'UW-super',
		@title = N'Professor',
		@Business_phoneNumber = N'1231321459',
		@Personal_Email = N'thatOneGuy@server.com',
		@line1 = N'149 Dillingham Road',
		@line2 = null,
		@city = N'Duluth',
		@state = N'MN',
		@zipCode = N'14285'

EXEC	addCLient
		@firstName = N'Jimmy',
		@lastName = N'John',
		@middleInitial = N'U',
		@permitNum = NULL,
		@notes = N'things and such',
		@orgName = N'FBI',
		@orgType = N'Government',
		@title = N'Inspector General',
		@Personal_phoneNumber = N'1121588745',
		@Personal_Email = N'MyAwsomeEmail@server.com',
		@line1 = N'1258 West King Road',
		@line2 = null,
		@city = N'Canada',
		@state = N'MN',
		@zipCode = N'14458'

EXEC	addCLient
		@prefix = 'Miss',
		@firstName = N'Timmy',
		@lastName = N'Stark',
		@middleInitial = NULL,
		@permitNum = NULL,
		@notes = NULL,
		@orgName = N'Microsoft',
		@orgType = N'Non-profit',
		@title = N'Grunt',
		@Personal_phoneNumber = N'5463151654',
		@Business_phoneNumber = N'5454651654',
		@Business_Email = N'BarbieGirl@server.com',
		@line1 = N'1894 WestBrook drive',
		@line2 = null,
		@city = N'Lakeshore',
		@state = N'TX',
		@zipCode = N'97841'

EXEC	addCLient
		@firstName = N'Larson',
		@lastName = N'Kitty',
		@middleInitial = N'C',
		@permitNum = N'H123',
		@notes = NULL,
		@orgName = N'Sears',
		@orgType = N'Non-profit',
		@title = N'Worker of somekind',
		@Business_phoneNumber = N'6573541245',
		@Personal_Email = N'KingSlayer@server.com',
		@line1 = N'18456 Darkshore road',
		@line2 = null,
		@city = N'Los Angeles',
		@state = N'CA',
		@zipCode = N'91458'

EXEC	addCLient
		@firstName = N'Timmmy',
		@lastName = N'Slim',
		@middleInitial = N'Y',
		@permitNum = NULL,
		@notes = NULL,
		@orgName = N'Org.net',
		@orgType = N'For-Profit',
		@title = N'Head Of Sales',
		@Business_phoneNumber = N'0123948547',
		@Personal_Email = N'ForTheHorde@server.com',
		@Personal_phoneNumber = N'2314564654',
		@Business_Email = N'ForTheAlliance@server.com',
		@line1 = N'14578 Nameless street',
		@line2 = null,
		@city = N'Superior',
		@state = N'CA',
		@zipCode = N'41547'

EXEC	addCLient
		@firstName = N'Izuku',
		@lastName = N'Midoria',
		@middleInitial = N'V',
		@permitNum = N'P000',
		@notes = NULL,
		@orgName = N'UA',
		@orgType = N'Non-profit',
		@title = N'Hero',
		@Personal_phoneNumber = N'4724561324',
		@Business_Email = N'AllmightFanboy@server.com',
		@line1 = N'18525 Noname road',
		@line2 = null,
		@city = N'Cityname',
		@state = N'WA',
		@zipCode = N'64564'

EXEC	addCLient
		@Prefix = 'Lt Coln.',
		@firstName = N'John',
		@lastName = N'Johnson',
		@middleInitial = N'Q',
		@permitNum = NULL,
		@notes = NULL,
		@orgName = N'PlaceTheyWorkFor',
		@orgType = N'Non-profit',
		@title = N'TitleTheyEarned',
		@Business_phoneNumber = N'5643617845',
		@Personal_Email = N'ILikeToWin@server.com',
		@line1 = N'454 Streetname road',
		@line2 = null,
		@city = N'ThisPlace',
		@state = N'KS',
		@zipCode = N'54654'

EXEC	addCLient
		@firstName = N'Johnson',
		@lastName = N'Johnnyboy',
		@middleInitial = N'O',
		@permitNum = NULL,
		@notes = NULL,
		@orgName = N'Principal''s Office',
		@orgType = N'High School',
		@title = N'Cheif Executive Officer',
		@Personal_phoneNumber = N'6543123216',
		@Business_Email = N'IDontLikePie@server.com',
		@line1 = N'4546 Slingshot road',
		@line2 = null,
		@city = N'Niles',
		@state = N'MI',
		@zipCode = N'79873'

EXEC	addCLient
		@firstName = N'Bo',
		@lastName = N'Jangles',
		@middleInitial = N'X',
		@permitNum = NULL,
		@notes = NULL,
		@orgName = N'Snapple',
		@orgType = N'distributor',
		@Personal_phoneNumber = N'5442135646',
		@Business_Email = N'IDontLikePi@server.com',
		@line1 = N'4546 Orange road',
		@line2 = null,
		@city = N'Spoontown',
		@state = N'WI',
		@zipCode = N'64461'

EXEC	addCLient
		@Prefix = 'Mr.',
		@firstName = N'Apple',
		@lastName = N'Orange',
		@permitNum = N'W432',
		@notes = NULL,
		@orgName = N'Superior DMV',
		@orgType = N'State',
		@title = NULL,
		@Business_phoneNumber = N'7463215645',
		@Personal_Email = N'single@server.com',
		@line1 = N'1 Springbrook dr.',
		@line2 = null,
		@city = N'Place',
		@state = N'WI',
		@zipCode = N'46489'

EXEC	addCLient
		@Prefix = 'Private',
		@firstName = N'Airbourne',
		@lastName = N'Ranger',
		@middleInitial = N'P',
		@permitNum = NULL,
		@notes = N'Very cool person',
		@orgName = N'Army',
		@orgType = N'Business',
		@title = N'BA',
		@Personal_phoneNumber = N'1691584511',
		@Personal_Email = N'coolGuy@server.com',
		@line1 = N'123 Awsome Stree',
		@line2 =  NULL,
		@city = N'superior',
		@state = N'WI',
		@zipCode = N'54880'

EXEC	addCLient
		@firstName = N'TickleMe',
		@lastName = N'Elmo',
		@middleInitial = N'Y',
		@permitNum = NULL,
		@notes = NULL,
		@orgName = N'Sesame Street',
		@orgType = N'Elected Official',
		@title = N'Tickleree',
		@Business_phoneNumber = N'1234561846',
		@Business_Email = N'tickleMeElmo@server.com',
		@line1 = N'895 Sesame Street',
		@line2 = NULL,
		@city = N'Milkwaukee',
		@state = N'TN',
		@zipCode = N'78445'

EXEC	addCLient
		@firstName = N'Cloud',
		@lastName = N'Strife',
		@middleInitial = N'J',
		@permitNum = NULL,
		@notes = N'Winner',
		@orgName = N'SOLDIER',
		@orgType = N'High School',
		@title = N'soldier',
		@Business_phoneNumber = N'7695851425',
		@Personal_Email = N'cloudStife@server.com',
		@line1 = N'855 Anywhere Dr.',
		@line2 = NULL,
		@city = N'Anywhere',
		@state = N'WA',
		@zipCode = N'58945'

EXEC	addCLient
		@firstName = N'Peter',
		@lastName = N'Griffin',
		@middleInitial = N'J',
		@permitNum = NULL,
		@notes = N'Cool guy',
		@orgName = N'Pawtucket Brewery',
		@orgType = N'High School',
		@title = N'line man',
		@Personal_phoneNumber = N'7395811448',
		@Personal_Email = N'birdIsTheWord@server.com',
		@line1 = N'31 Spooner Street',
		@line2 = NULL,
		@city = N'Quahog',
		@state = N'RI',
		@zipCode = N'45589',
		@Assistant_phoneNumber = '561654684',
		@Assistant_Email = 'assistantEmail2020@server.com',
		@assistantFirstName = 'Meg',
		@assistantLastName = 'Griffin'

EXEC	addCLient
		@firstName = N'Louis',
		@lastName = N'Griffin',
		@middleInitial = N'E',
		@permitNum = NULL,
		@notes = N'Wifey',
		@orgName = N'StayAtHome',
		@orgType = N'Foundation',
		@title = N'MOM',
		@Personal_phoneNumber = N'6982341584',
		@Personal_Email = N'birdIsTheWord2@server.com',
		@line1 = N'31 Spooner Street',
		@line2 = NULL,
		@city = N'Quahog',
		@state = N'RI',
		@zipCode = N'45589'

EXEC	addCLient
		@firstName = N'Stewie',
		@lastName = N'Griffin',
		@middleInitial = N'E',
		@permitNum = NULL,
		@notes = N'very smart',
		@orgName = N'TS Goverment Facility',
		@orgType = N'Elementry',
		@title = NULL,
		@Business_phoneNumber = N'1253651452',
		@Business_Email = N'birdIsTheWord3@server.com',
		@line1 = N'31 Spooner Street',
		@line2 = NULL,
		@city = N'Quahog',
		@state = N'RI',
		@zipCode = N'45589',
		@Assistant_phoneNumber = '151564548',
		@Assistant_Email = 'assistantEmail2012@server.com',
		@assistantFirstName = 'Yarez',
		@assistantLastName = 'Rain'

EXEC	addCLient
		@firstName = N'Stew',
		@lastName = N'Griffin',
		@middleInitial = N'E',
		@permitNum = NULL,
		@notes =  NULL,
		@orgName = N'TS Goverment Facility',
		@orgType = N'Elementry',
		@title = NULL,
		@Personal_phoneNumber = N'9872131321',
		@Personal_Email = N'birdIsTheWord4@server.com',
		@line1 = N'31 Spooner Street',
		@line2 = NULL,
		@city = N'Quahog',
		@state = N'RI',
		@zipCode = N'45589'

EXEC	addCLient
		@firstName = N'Sally',
		@lastName = N'Sue',
		@middleInitial = N'I',
		@permitNum = NULL,
		@notes = NULL,
		@orgName = N'LocalCompany',
		@orgType = N'Business',
		@title = NULL,
		@Personal_phoneNumber = N'6455645648',
		@Personal_Email = N'mai1_1231@server.com',
		@line1 = N'5646 Farangton Rd.',
		@line2 = NULL,
		@city = N'ThisCity',
		@state = N'OH',
		@zipCode = N'56465'

EXEC	addCLient
		@firstName = N'Sally',
		@lastName = N'Stone',
		@middleInitial = NULL,
		@permitNum = NULL,
		@notes = NULL,
		@orgName = N'Hayward',
		@orgType = N'High School',
		@title = NULL,
		@Personal_phoneNumber = N'9876581544',
		@Personal_Email = N'mail_6546@server.com',
		@line1 = NULL,
		@line2 = NULL,
		@city = NULL,
		@state = NULL,
		@zipCode = NULL

EXEC	addCLient
		@firstName = N'Xion',
		@lastName = N'Angler',
		@middleInitial = N'E',
		@permitNum = NULL,
		@notes = NULL,
		@orgName = N'LocalBusiness2',
		@orgType = N'Business',
		@title = NULL,
		@Business_phoneNumber = N'7853541654',
		@Personal_Email = N'mail_123@server.com',
		@line1 = N'1211 Elementy Road',
		@line2 = NULL,
		@city = N'Ontario',
		@state = N'OH',
		@zipCode = N'45614'

EXEC	addCLient
		@firstName = N'Steven',
		@lastName = N'Stone',
		@middleInitial = N'Y',
		@permitNum = NULL,
		@notes = NULL,
		@orgName = N'Spoontown',
		@orgType = N'High School',
		@title = NULL,
		@Personal_phoneNumber = N'5641211312',
		@Personal_Email = N'mailbox@server.com',
		@line1 = NULL,
		@line2 = NULL,
		@city = NULL,
		@state = NULL,
		@zipCode = NULL

EXEC	addCLient
		@firstName = N'Steven',
		@lastName = N'Stoney',
		@middleInitial = N'Q',
		@permitNum = NULL,
		@notes = NULL,
		@orgName = N'Superior',
		@orgType = N'High School',
		@title = NULL,
		@Business_phoneNumber = N'4841215466',
		@Business_Email = N'FRIDAY@server.com',
		@line1 = N'124 Spring Street',
		@line2 = NULL,
		@city = N'Sincinaty',
		@state = N'WA',
		@zipCode = N'54656',
		@Assistant_phoneNumber = '2451245121',
		@Assistant_Email = 'assistantEmail95@server.com',
		@assistantFirstName = 'Jim',
		@assistantLastName = 'Bob'


UPDATE Client SET Active = 0 WHERE Last_Name = 'Stoney'

UPDATE Client SET Active = 0 WHERE First_Name = 'Xion'

UPDATE Client SET Active = 0 WHERE First_Name = 'Stew'

UPDATE Client SET Active = 0 WHERE First_Name = 'Airbourne'

UPDATE Client SET Active = 0 WHERE First_Name = 'Matt'

UPDATE Client SET Active = 0 WHERE First_Name = 'Bo'

UPDATE Client SET Active = 0 WHERE First_Name = 'Sally'

END
GO
