@model SUP_MVC.Models.Search.SearchViewModel

@{
    ViewData["Title"] = "Search";
}
<html>
<head>
    <meta charset="utf-8">
    <title>Search</title>
    <style>
        body {
            margin-left: 0px;
            margin-top: 0px;
            margin-right: 0px;
            margin-bottom: 0px;
        }
        .organize {
            width: 100%;
            height: 100%;
        }

        .logo {
            height: 95%;
            float: right;
            top: 1px;
            margin-top: 2px;
            margin-right: 2px;
        }

        .universitylogo {
            height: 95%;
            float: right;
            top: 1px;
            margin-top: 2px;
            margin-right: 2px;
        }

        #button {
            text-align: inherit;
        }

        .popupForm {
            display: none;
            background-color: #E0E0E0;
            border: 1px solid black;
            position: fixed;
            bottom: 10%;
            top: 10%;
            left: 10%;
            right: 10%;
        }

        .auto_hidden {
            width: 200px;
            border:#E0E0E0;
            border-top: 1px solid ;
            border-bottom: 1px solid;
            border-left: 1px solid;
            border-right: 1px solid;
            position: absolute;
            display: none;
        }

        .auto_show {
            width: 200px;
            border:#E0E0E0;
            border-top: 1px solid;
            border-bottom: 1px solid;
            border-left: 1px solid;
            border-right: 1px solid;
            position: absolute;
            z-index: 9999;
            display: block;
        }

        .auto_onmouseover {
            color: #ffffff;
            background-color: highlight;
            width: 100%;
        }

        .auto_onmouseout {
            color: #000000;
            width: 100%;
            background-color: #ffffff;
        }
    </style>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>

    <script>
        $(document).ready(function () {
            Search();
            $('.searchOrganization').change(function () {
                Search();
            });
            $('.checkAll').click(function () {
                var checkedAll = false;
                checkedAll = $('.checkAll').prop('checked');
                $('.rowSelected').each(function () {
                    if (checkedAll != $(this).prop('checked')) {
                        $(this).click();
                    }
                });
            })
        })

        var returnedData;
        function Search() {
            var firstName = $('.searchFirstName').val();
            var lastName = $('.searchLastName').val();
            var organization = $(".searchOrganization option:selected").text(); //$('.searchOrganization').val();
            var active = ($('.displayOnlyActiveClientsInput:checked').length >= 1);
            var dataPost = firstName + ',' + lastName + ',' + organization + ',' + active;
            $.ajax({
                url: '/Search/SearchClients',
                type: 'POST',
                data: JSON.stringify(dataPost),
                contentType: 'application/json; charset=utf-8',
                error: function (xhr) {
                    alert('Error: ' + xhr.statusText);
                },
                success: function (result) {
                    returnedData = JSON.parse(result);
                    

                    $('.removableRow').remove();
                    $('.templateRow').hide();
                    if (returnedData.length == 0) {
                        $('.templateRow').show();
                    }
                    for (var i = 0; i < returnedData.length; i++) {
                        var currentRow = returnedData[i];
                        var Row = $('.templateRow').clone();
                        Row.removeClass('templateRow').addClass('removableRow').show();
                        Row.find('.rowFirstName').val(currentRow['First_Name']);
                        Row.find('.rowLastName').val(currentRow['Last_Name']);
                        if (currentRow['Email'] != null)
                            Row.find('.rowEmailAddress').val(currentRow['Email']['Email']);
                        if (currentRow['Phone'] != null)
                            Row.find('.rowPhoneNumber').val(currentRow['Phone']['Number']);
                        if (currentRow['Org'] != null) {
                            Row.find('.rowOrganization').val(currentRow['Org']['Org_Name']);
                        }
                        var clientId = currentRow['ID']
                        Row.find('.rowViewButton').val(clientId);
                        $('.checkedId').each(function (index) {
                            if ($(this).text() == clientId) {
                                Row.find('.rowSelected').prop('checked', true);
                            }
                        });
                        $('.templateRow').parent().append(Row);
                    }
                    $('.rowViewButton').unbind('click').click(function () {
                        editClient($(this).val());
                    });
                    $('.rowSelected').unbind('click');
                    $('.rowSelected').click(function () {
                        var clientId = $(this).parent().parent().find('.rowViewButton').val();
                        if ($(this).prop('checked') == true) {
                            var Row = $('.checkedIdTemplate').clone();
                            Row.removeClass('checkedIdTemplate').addClass('checkedId');
                            Row.text(clientId);
                            $('.checkedIdsDiv').append(Row);
                        } else {
                            $('.checkedId').each(function (index) {
                                if ($(this).text() == clientId) {
                                    $(this).remove();
                                }
                            });
                        }
                    });
                },
                async: true,
                processData: false
            });
        }


        function editClient(clientId) {
            location.href = '/AddClient/AddClient?clientId=' + clientId;
        }

        function popSetup() {
      document.getElementById("setup").style.display = "flex";
    }

    function closeSetup() {
      document.getElementById("setup").style.display = "none";
    }
    function popConfirm() {
      document.getElementById("confirmation").style.display = "flex";
    }
    function closeConfirm() {
      document.getElementById("confirmation").style.display = "none";
    }
        function toggle(source) {
            var checkboxes = document.getElementsByName('selectAll');
            for (var checkbox in checkboxes)
                checkbox.checked = source.checked;
        }

        function allCheck(name, boolValue) {
            var allvalue = document.getElementsByName(name);
            for (var i = 0; i < allvalue.length; i++) {
                if (allvalue[i].type == "checkbox")
                    allvalue[i].checked = boolValue;
            }
        }

        function reserveCheck(name) {
            var revalue = document.getElementsByName(name);
            for (i = 0; i < revalue.length; i++) {
                if (revalue[i].checked == true)
                    revalue[i].checked = false;
                else
                    revalue[i].checked = true;
                // revalue[i].checked = selected;
            }
        }



        var $ = function (id)
        {
            return "string" == typeof id ? document.getElementById(id) : id;
        }
        var combine = function (result, a) {
            return function () {
                return a.apply(result, arguments);
            }
        }
        function AutoComplete(input, node_Div, repeat) {
            this.input = $(input);        
            this.node_Div = $(node_Div);
            this.noRepeat = repeat;        
            this.index = -1;          //index on div
            this.searchValue = "";   //save searching input
        }
        AutoComplete.prototype = {
            //initialize the div position
            initialize: function () {
                this.node_Div.style.left = this.input.offsetLeft + "px";
                this.node_Div.style.top = this.input.offsetTop + this.input.offsetHeight +35 + "px";
                this.node_Div.style.width = this.input.offsetWidth - 2 + "px";
            },

            deleteDiv: function () {
                while (this.node_Div.hasChildNodes()) {
                    this.node_Div.removeChild(this.node_Div.firstChild);
                }
                this.node_Div.className = "auto_hidden";
            },

            setValue: function (object) {
                return function () {
                    object.input.value = this.seq;
                    object.node_Div.className = "auto_hidden";
                }
            },

            autoOnmouseover: function (object, index_div) {
                return function () {
                    var length;
                    object.index = index_div;
                    length = object.node_Div.children.length;
                    for (var i = 0; i < length; i++) {
                        if (i != object.index) {
                            object.node_Div.childNodes[i].className = 'auto_onmouseout';
                        } else {
                            object.node_Div.childNodes[i].className = 'auto_onmouseover';
                        }
                    }
                }
            },

            nameChanged: function (length) {
                for (var i = 0; i < length; i++) {
                    if (i != this.index) {
                        this.node_Div.childNodes[i].className = 'auto_onmouseout';
                    } else {
                        this.node_Div.childNodes[i].className = 'auto_onmouseover';
                        this.input.value = this.node_Div.childNodes[i].seq;
                    }
                }
            }
            ,

            pressKey: function (event) {
                var length = this.node_Div.children.length;
                //"↓"
                if (event.keyCode == 40) {
                    ++this.index;
                    if (this.index > length)
                    {
                        this.index = 0;
                    }
                    else if (this.index == length) {
                        this.input.value = this.searchValue;
                    }
                    this.nameChanged(length);
                }
                //"↑"
                else if (event.keyCode == 38) {
                    this.index--;
                    if (this.index < -1) {
                        this.index = length - 1;
                    } else if (this.index == -1) {
                        this.input.value = this.searchValue;
                    }
                    this.nameChanged(length);
                }
                //enter
                else if (event.keyCode == 13) {
                    this.node_Div.className = "auto_hidden";
                    this.index = -1;
                } else {
                    this.index = -1;
                }
            },

            start: function (event) {
                if (event.keyCode != 13 && event.keyCode != 38 && event.keyCode != 40) {
                    this.initialize();
                    this.deleteDiv();
                    this.searchValue = this.input.value;
                    var arrV = this.noRepeat;
                    if (arrV != undefined && arrV != null) {
                        arrV.sort();
                    }
                    if (this.input.value.replace(/(^\s*)|(\s*$)/g, '') == "") { return; }
                    try { var reg = new RegExp("(" + this.input.value + ")", "i"); }
                    catch (e) { return; }
                    var index = 0;
                    for (var i = 0; i < arrV.length; i++) {
                        if (reg.test(arrV[i])) {
                            var div = document.createElement("div");
                            div.className = "auto_onmouseout";
                            div.seq = arrV[i];
                            div.onclick = this.setValue(this);
                            div.onmouseover = this.autoOnmouseover(this, index);
                            div.innerHTML = arrV[i].replace(reg, "<strong>$1</strong>");
                            this.node_Div.appendChild(div);
                            this.node_Div.className = "auto_show";
                            index++;
                        }
                    }
                }
                this.pressKey(event);
                window.onresize = combine(this, function () { this.initialize(); });
            }
        }
     

            /**/</script>
</head>


<body class="organize">
    <div class="checkedIdsDiv" style="display:none;">
        <p class="checkedIdTemplate"></p>
    </div>
    <div style="position: absolute; left: 15%; top: 10%; width: 85%;">
        <div style="position:relative; margin-left: 25%; width: 650px;" align="right">
            <form>
                <table style="position:relative; left: -90px">
                    <tr>
                        <td>
                            <p align="center">First Name</p>
                        </td>
                        <td>
                            <p align="center">Last Name</p>
                        </td>
                        <td>
                            <p align="center">Organization Type</p>
                        </td>
                    </tr>


                    <tr>
                        <td>

                            <input class="searchFirstName" id="search_FirstName" property="firstNameBeginText" type="text" onKeyUp="Search(),autoComplete.start(event)" placeholder="First Name">
                            <div class="auto_hidden" id="auto"></div>
                            <script>
                                var autoComplete = new AutoComplete('search_FirstName', 'auto', returnedData);//returnedData caused sort, event error
                            </script>

                        </td>
                        <td>
                            <input class="searchLastName" type="text" onKeyUp="Search()" placeholder="Last Name">
                        </td>
                        <td>
                            <select class="searchOrganization" onKeyUp="Search()" name="category">
                                <!--We need to keep an empty option to allow searches that do not include organization-->
                                <option value=""></option>
                                <option value="business">Business</option>
                                <option value="electedOfficial">Elected Official</option>
                                <option value="school">School</option>
                                <option value="elementary">Elementary</option>
                                <option value="middle">Middle</option>
                                <option value="highSchool">High School</option>
                                <option value="higherEd">Higher Ed.</option>
                                <option value="nonProfit">Non-profit</option>
                                <option value="UWSystem">UW-System</option>
                                <option value="boardOfRegent">Board of Regent</option>
                                <option value="foundation">Foundation</option>
                                <option value="other">Other</option>
                            </select>
                        </td>
                    </tr>
                    <tr><td height="10px"></td></tr>


                </table>
            </form>
            <div style="float:left; margin-left: calc(10% + 180px);">
                <p style="float:left;">Display active only: </p>
                <input style="margin-left:12px; margin-top:12px;" type="checkbox" onchange="Search()" class="displayOnlyActiveClientsInput" />
            </div>
        </div>
        <table style="float:left; position:relative; margin-left: calc(10% + 120px); left: -15px">
            <tbody>
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>
                        <a href="javascript:allCheck('choice',true)">Select</a>
                        <a href="javascript:allCheck('choice',false)">No select</a>
                        <a href="javascript:reserveCheck('choice')"> Inverse</a>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td style="width: 183px">
                        <p><b>First Name</b></p>
                    </td>
                    <td style="width: 188px">
                        <p><b>Last Name</b></p>
                    </td>
                    <td style="width: 199px">
                        <p><b>Organization Name</b></p>
                    </td>
                    <td style="width: 175px">
                        <p><b>Email</b></p>
                    </td>
                    <td style="width: 128px">
                        <p><b>Phone #</b></p>
                    </td>
                    <td>
                        <input class="checkAll" type="checkbox" name="choice" id="choice">
                    </td>
                </tr>
            </tbody>
        </table>
        <div style="height: 420px; overflow-y:scroll; overflow-x: hidden; width: 1050px; margin-left: calc(10% - 20px);" align="right">
            <table style="position:relative; left: -20px">
                <tbody>
                    <tr class="templateRow" style="">
                        <td>
                            <button class="rowViewButton" value="0">View</button>
                        </td>
                        <td>
                            <input class="rowFirstName" type="text" value="" disabled>
                        </td>
                        <td>
                            <input class="rowLastName" type="text" value="" disabled>
                        </td>
                        <td>
                            <input class="rowOrganization" type="text" value="" disabled>
                        </td>
                        <td>
                            <input class="rowEmailAddress" type="text" value="" disabled>
                        </td>
                        <td>
                            <input class="rowPhoneNumber" type="text" value="" disabled>
                        </td>
                        <td>
                            <input class="rowSelected" type="checkbox" name="choice" id="choice" />
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <button class="template" onclick="popSetup()">Select Template</button>
        <div class="setup" id="setup">
    <div class="topRow">
      <img src="superior_logo.jpg" style="max-height: 100%">
      <img src="logo.jpg" style="max-height: 100%">
    </div>
    <div class="searchRow">
      <form action="middlewareHere">
        <div>
          <input type="text" style="width: 80%">
          <input type="submit" value="search" style="width: 15%">
        </div>
      </form>
    </div>
    <div class="resultRow">
      <table id="poptable">
        <tr>
          <th>&nbsp;</th>
          <th>Name</th>
          <th>Date modified</th>
          <th>Uploaded by</th>
        </tr>
        <tr>
          <td id="radioSet"><input type="radio" name="template"></td>
          <td id="colSet">ParkingPassTemplate</td>
          <td id="colSet">9/9/9999</td>
          <td id="colSet">username1</td>
        </tr>
        <tr>
          <td id="radioSet"><input type="radio" name="template"></td>
          <td id="colSet">LetterTemplate</td>
          <td id="colSet">8/8/8888</td>
          <td id="colSet">thatOneGuy17</td>
        </tr>
        <tr>
          <td id="radioSet"><input type="radio" name="template"></td>
          <td id="colSet">HolidayCardTemplate</td>
          <td id="colSet">1/19/2019</td>
          <td id="colSet">buttercup2000</td>
        </tr>
      </table>
    </div>
    <div class="buttonRow">
      <button class="continue" onclick="popConfirm()">Continue</button>
    </div>
    <div class="buttonRow">
      <form action="middlewareHere" method="POST" enctype="multipart/form-data">
        <input type="file" class="browse" name="browse">
        <button type="submit" class="addTemplate" value="Add Template">Add Template</button>
      </form>
      <button class="closeButton"  onclick="closeSetup()">Close</button>
    </div>
  </div>

  <div class="confirmation" id="confirmation">
    <div class="topRow">
      <img src="superior_logo.jpg" style="max-height: 100%">
      <img src="logo.jpg" style="max-height: 100%">
    </div>
    <div class="resultRow">
      <table id="poptable">
        <tr>
          <th>Result</th>
        </tr>
        <tr>
          <td id="colSet">Generated 17 parking permits.</td>
        </tr>
      </table>
    </div>
    <div class="buttonRow">
      <form action="middlewareHere">
        <button type="submit" class="continue">Generate Output</button>
      </form>
    </div>
    <div class="buttonRow">
      <a href="middlewareHere" download>
        <button class="browse">Download Output</button>
      </a>
      <button class="addTemplate" onclick="closeConfirm()">Go Back</button>

      <button class="closeButton"  onclick="closeConfirm(), closeSetup()">Return to Search</button>
    </div>
  </div>
    </div>
</body>
</html>
